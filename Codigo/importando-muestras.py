import os
import shutil
import yara

# Ruta al directorio principal que deseas explorar
directorio_principal = "/home/cape/Desktop/Ejercicio_1/Virus/Samples"  # Cambia esto al directorio que desees explorar

# Ruta al archivo de reglas YARA compiladas
compiled_rules_path = "/home/cape/Desktop/Ejercicio_1/repositorios/rules_compiled"

# Ruta de la carpeta para almacenar los archivos matcheados
carpeta_archivos_matcheados = "/home/cape/Desktop/Ejercicio_1/Virus/samples"  # Cambia esto a la carpeta donde deseas almacenar los archivos

# Carga las reglas YARA previamente compiladas
rules = yara.load(compiled_rules_path)

def analizar_archivo(ruta_archivo):
    try:
        # Aplica las reglas al archivo
        matches = rules.match(ruta_archivo)

        # Si hay coincidencias y no hay errores, copia el archivo a la carpeta específica
        if matches:
            # Extrae el nombre del archivo
            nombre_archivo = os.path.basename(ruta_archivo)

            # Construye la ruta de destino en la carpeta de archivos matcheados
            ruta_destino = os.path.join(carpeta_archivos_matcheados, nombre_archivo)

            # Copia el archivo a la carpeta de archivos matcheados
            shutil.copy2(ruta_archivo, ruta_destino)

    except Exception as e:
        print(f'Error al analizar {ruta_archivo}: {str(e)}')

# Itera sobre el directorio principal y sus subdirectorios
for carpeta_actual, _, archivos in os.walk(directorio_principal):
    for archivo in archivos:
        ruta_completa = os.path.join(carpeta_actual, archivo)
        # Llama a la función de análisis para cada archivo
        analizar_archivo(ruta_completa)