import os
import yara

# Ruta al directorio principal que deseas explorar
directorio_principal = "/home/cape/Desktop/Ejercicio_1/Virus/Samples"  # Cambia esto al directorio que desees explorar

# Ruta al archivo de reglas YARA compiladas
compiled_rules_path = "/home/cape/Desktop/Ejercicio_1/repositorios/rules_compiled"

# Ruta de la carpeta para almacenar los resultados de coincidencias
carpeta_coincidencias = "/home/cape/Desktop/Ejercicio_1/Virus/matches"  # Cambia esto a la carpeta donde deseas almacenar los resultados

# Ruta de la carpeta para almacenar los resultados sin coincidencias
carpeta_no_coincidencias = "/home/cape/Desktop/Ejercicio_1/Virus/non-matches"  # Cambia esto a la carpeta donde deseas almacenar los resultados

# Carga las reglas YARA previamente compiladas
rules = yara.load(compiled_rules_path)

def analizar_archivo(ruta_archivo):
    try:
        # Aplica las reglas al archivo
        matches = rules.match(ruta_archivo)

        # Prepara el contenido para el archivo de resultados
        contenido_resultados = ""
        if matches:
            contenido_resultados = "Coincidencias encontradas:\n"
            for match in matches:
                contenido_resultados += f"{match.rule}\n"
        else:
            contenido_resultados = "No se encontraron coincidencias."

        # Extrae el nombre del archivo
        nombre_archivo = os.path.basename(ruta_archivo)

        # Decide en qué carpeta guardar los resultados
        if matches:
            carpeta_resultados = carpeta_coincidencias
        else:
            carpeta_resultados = carpeta_no_coincidencias

        # Crea el archivo de resultados
        ruta_resultados = os.path.join(carpeta_resultados, f"{nombre_archivo}.txt")
        with open(ruta_resultados, 'w') as archivo_resultados:
            archivo_resultados.write(contenido_resultados)
    except Exception as e:
        print(f'Error al analizar {ruta_archivo}: {str(e)}')

# Itera sobre el directorio principal y sus subdirectorios
for carpeta_actual, _, archivos in os.walk(directorio_principal):
    for archivo in archivos:
        ruta_completa = os.path.join(carpeta_actual, archivo)
        # Llama a la función de análisis para cada archivo
        analizar_archivo(ruta_completa)